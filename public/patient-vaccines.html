<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Available Vaccines — Patient</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{
    --accent:#0b5cff;
    --accent2:#0ea5a4;
    --bg:#f6f9ff;
    --card:#ffffff;
    --muted:#6b7280;
    --danger:#ef4444;
    --warning:#f59e0b;
    --ok:#10b981;
    --radius:14px;
    font-family: Inter, system-ui, Arial, sans-serif;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#fbfdff,var(--bg));color:#0f172a}
  header{
    background:white;border-bottom:1px solid #e6eef8;padding:12px 18px;display:flex;align-items:center;justify-content:space-between;
    position:sticky;top:0;z-index:10;
  }
  .logo{font-weight:800;color:var(--accent);font-size:18px}
  nav a{margin-left:10px;text-decoration:none;color:var(--muted);padding:8px 12px;border-radius:10px;font-weight:600}
  nav a:hover{background:#eef4ff;color:var(--accent)}
  nav a.active{background:#eef4ff;color:var(--accent);font-weight:700}

  .wrap{max-width:1150px;margin:20px auto;padding:14px}

  h1{margin:0;font-size:24px;font-weight:800}
  .muted{color:var(--muted);margin-top:6px}

  .toolbar{display:flex;gap:12px;align-items:center;margin-top:18px;flex-wrap:wrap}
  .search{flex:1;min-width:220px;padding:10px;border-radius:10px;border:1px solid #e6eef8}
  select, input[type="number"]{padding:10px;border-radius:10px;border:1px solid #e6eef8}

  .grid{
    margin-top:18px;
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:16px;
  }

  .vcard{
    background:var(--card);padding:14px;border-radius:12px;border:1px solid #eef4ff;
    box-shadow:0 10px 22px rgba(10,30,80,0.04);
    display:flex;flex-direction:column;gap:10px;
  }

  .vtop{display:flex;gap:12px;align-items:center}
  .vimg{
    width:68px;height:68px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#2bb6ff);
    display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:18px;
    flex-shrink:0;
  }
  .vtitle{font-weight:800;font-size:16px}
  .vsub{color:var(--muted);font-size:13px}

  .meta{display:flex;gap:10px;flex-wrap:wrap;font-size:13px;color:var(--muted)}
  .qty{font-weight:800}
  .avail-pill{padding:6px 10px;border-radius:12px;color:white;font-weight:700;font-size:13px}

  .card-actions{margin-top:auto;display:flex;gap:8px;justify-content:space-between;align-items:center}
  .btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--accent);color:white}
  .btn.ghost{background:#f8fafc;border:1px solid #e6eef8;color:#0b2455}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(6,8,20,0.45);display:none;align-items:center;justify-content:center;z-index:60}
  .modal{background:white;width:95%;max-width:820px;border-radius:14px;padding:18px;box-shadow:0 30px 70px rgba(6,8,20,0.4)}
  .modal .h{display:flex;justify-content:space-between;align-items:center}
  .modal .h h2{margin:0}
  .close{background:#ef4444;color:white;border:none;padding:8px 10px;border-radius:10px;cursor:pointer}
  .detail-grid{display:grid;grid-template-columns:1fr 260px;gap:16px;margin-top:12px}
  .vdesc{white-space:pre-wrap;line-height:1.5;color:#0f172a}
  .side-effects{background:#fff7f5;padding:10px;border-radius:10px;border:1px solid #ffe2d5;color:#6b2a1f}
  @media(max-width:700px){ .detail-grid{grid-template-columns:1fr} }

  .note{font-size:13px;color:var(--muted);margin-top:8px}
</style>
</head>
<body>

<header>
  <div class="logo">Vaccination Portal</div>
  <nav>
    <a href="dashboard-patient.html">Dashboard</a>
    <a href="patient-profile.html">Profile</a>
    <a class="active" href="patient-vaccines.html">Vaccines</a>
    <a href="patient-appointment-book.html">Book Appointment</a>
    <a href="patient-appointments.html">My Appointments</a>
    <a href="patient-certificates.html">Certificates</a>
    <a href="patient-notifications.html">Notifications</a>
    <a href="patient-feedback.html">Feedback</a>
    <a id="logoutBtn" style="background:#ef4444;color:white;padding:8px 10px;border-radius:10px;text-decoration:none">Logout</a>
  </nav>
</header>

<div class="wrap">
  <h1>Available Vaccines</h1>
  <div class="muted">Dekhiye kaunse vaccines available hain — stock live, side-effects, age requirement aur price bhi.</div>

  <div class="toolbar">
    <input id="q" class="search" placeholder="Search vaccine name...">
    <select id="doseFilter">
      <option value="">All dose types</option>
      <option value="1st">1st</option>
      <option value="2nd">2nd</option>
      <option value="booster">Booster</option>
    </select>
    <input id="minAge" type="number" placeholder="Min age" style="width:110px">
    <button class="btn ghost" id="btnRefresh">Refresh</button>
    <div style="margin-left:auto" id="stats" class="note"></div>
  </div>

  <div id="grid" class="grid" style="margin-top:12px"></div>

  <div id="empty" class="note" style="display:none;margin-top:12px">No vaccines found for selected filters.</div>
</div>

<!-- DETAILS MODAL -->
<div id="modalBk" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="h">
      <h2 id="mdTitle">Vaccine</h2>
      <button class="close" id="mdClose">Close</button>
    </div>

    <div class="detail-grid">
      <div>
        <div class="vdesc" id="mdDesc">Loading...</div>

        <div style="margin-top:12px">
          <strong>Manufacturer:</strong> <span id="mdMan" class="muted"></span><br>
          <strong>Required age:</strong> <span id="mdAge" class="muted"></span><br>
          <strong>Price:</strong> <span id="mdPrice" class="muted"></span><br>
          <strong>Doses required:</strong> <span id="mdDoses" class="muted"></span>
        </div>
      </div>

      <div>
        <div style="background:#f8fbff;padding:12px;border-radius:10px">
          <div style="font-weight:800" id="mdQty">Qty: --</div>
          <div class="note" id="mdAvailNote">Availability</div>

          <div style="margin-top:12px">
            <button class="btn primary" id="mdBook">Book This Vaccine</button>
            <a id="mdMore" class="btn" style="background:#f3f4f6;color:#0b2455;margin-left:8px">View Clinical Info</a>
          </div>
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:700;margin-bottom:6px">Side Effects</div>
          <div class="side-effects" id="mdSide">Loading...</div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
(async function(){
  const token = localStorage.getItem('authToken');
  const user = JSON.parse(localStorage.getItem('user') || '{}');

  if(!token){
    alert('Please login first');
    location.href='login.html';
    return;
  }
  if(user.role !== 'patient'){
    alert('Only patients can view this page');
    location.href = user.role === 'admin' ? 'dashboard-admin.html' : 'dashboard.html';
    return;
  }

  const qEl = document.getElementById('q');
  const doseFilter = document.getElementById('doseFilter');
  const minAge = document.getElementById('minAge');
  const btnRefresh = document.getElementById('btnRefresh');
  const grid = document.getElementById('grid');
  const empty = document.getElementById('empty');
  const stats = document.getElementById('stats');

  const modalBk = document.getElementById('modalBk');
  const mdClose = document.getElementById('mdClose');
  const mdTitle = document.getElementById('mdTitle');
  const mdDesc = document.getElementById('mdDesc');
  const mdMan = document.getElementById('mdMan');
  const mdAge = document.getElementById('mdAge');
  const mdPrice = document.getElementById('mdPrice');
  const mdDoses = document.getElementById('mdDoses');
  const mdQty = document.getElementById('mdQty');
  const mdSide = document.getElementById('mdSide');
  const mdBook = document.getElementById('mdBook');
  const mdAvailNote = document.getElementById('mdAvailNote');
  const mdMore = document.getElementById('mdMore');

  let vaccines = [], inventory = [];

  async function loadAll(){
    grid.innerHTML = 'Loading...';
    try{
      const [vRes, iRes] = await Promise.all([
        fetch('/api/vaccines',{ headers: { 'Authorization':'Bearer '+token }}),
        fetch('/api/inventory',{ headers: { 'Authorization':'Bearer '+token }})
      ]);
      vaccines = await vRes.json();
      inventory = await iRes.json();

      // compute available qty per vaccine (sum inventory.quantity where vaccine_id matches and expiry not passed)
      const now = new Date().toISOString().slice(0,10);
      const qtyMap = {};
      inventory.forEach(it=>{
        // basic expiry check if expiry_date exists
        if(it.expiry_date && it.expiry_date < now) return;
        if(!qtyMap[it.vaccine_id]) qtyMap[it.vaccine_id]=0;
        qtyMap[it.vaccine_id] += (parseInt(it.quantity) || 0);
      });

      vaccines.forEach(v => { v.available_qty = qtyMap[v.id] || 0 });

      render();
    }catch(e){
      console.error('Load error', e);
      grid.innerHTML = '<div class="note">Error loading data. Try refresh.</div>';
    }
  }

  function availabilityColor(q){
    if(q <= 0) return {text:'Out of stock', color: 'var(--danger)'};
    if(q <= 10) return {text:'Low stock', color: 'var(--warning)'};
    return {text:'Available', color: 'var(--ok)'};
  }

  function render(){
    const q = qEl.value.trim().toLowerCase();
    const dose = doseFilter.value;
    const minA = parseInt(minAge.value) || 0;

    const filtered = vaccines.filter(v => {
      if(dose && (String(v.dose_type || '').toLowerCase().indexOf(dose.toLowerCase()) === -1)) return false;
      if(minA && (v.required_age || 0) > 0 && v.required_age > 0 && v.required_age > 0 && (minA < v.required_age ? false : true) === false) {
        // if filter means patient wants minAge >= required_age? simpler: ignore complicated logic
      }
      if(minA && (v.required_age || 0) > minA) return false;
      if(q && !((v.name||'').toLowerCase().includes(q) || (v.manufacturer||'').toLowerCase().includes(q))) return false;
      return true;
    });

    grid.innerHTML = '';
    if(!filtered.length){
      empty.style.display = 'block';
      stats.innerText = `${vaccines.length} total`;
      return;
    }
    empty.style.display = 'none';
    stats.innerText = `${filtered.length} shown of ${vaccines.length}`;

    filtered.forEach(v=>{
      const card = document.createElement('div');
      card.className = 'vcard';

      const top = document.createElement('div'); top.className='vtop';
      const img = document.createElement('div'); img.className='vimg'; img.innerText = (v.name||'').split(' ').map(x=>x[0]).slice(0,2).join('');
      const t = document.createElement('div');
      t.innerHTML = `<div class="vtitle">${escapeHtml(v.name)}</div><div class="vsub">${escapeHtml(v.manufacturer||'')}</div>`;
      top.appendChild(img); top.appendChild(t);

      const meta = document.createElement('div'); meta.className='meta';
      const doseType = document.createElement('div'); doseType.innerHTML = `Dose: <strong>${escapeHtml(v.dose_type || 'N/A')}</strong>`;
      const reqAge = document.createElement('div'); reqAge.innerHTML = `Min Age: <strong>${v.required_age||0}</strong>`;
      const price = document.createElement('div'); price.innerHTML = `Price: <strong>${(v.price||0).toString()}</strong>`;
      meta.appendChild(doseType); meta.appendChild(reqAge); meta.appendChild(price);

      const qtyLine = document.createElement('div');
      qtyLine.innerHTML = `Quantity: <span class="qty">${v.available_qty}</span>`;
      const avail = availabilityColor(v.available_qty);
      const pill = document.createElement('div'); pill.className='avail-pill'; pill.style.background = avail.color; pill.innerText = avail.text;

      const actions = document.createElement('div'); actions.className='card-actions';
      const btnDetails = document.createElement('button'); btnDetails.className='btn ghost'; btnDetails.innerText='View Details';
      btnDetails.onclick = ()=> openModal(v);
      const btnBook = document.createElement('button'); btnBook.className='btn primary'; btnBook.innerText='Book';
      btnBook.onclick = ()=> {
        // go to appointment booking page and preselect vaccine via query param
        location.href = 'patient-appointment-book.html?vaccine_id=' + v.id;
      };
      if(v.available_qty <= 0) btnBook.disabled = true;

      actions.appendChild(pill); actions.appendChild(btnDetails); actions.appendChild(btnBook);

      card.appendChild(top);
      card.appendChild(meta);
      card.appendChild(qtyLine);
      card.appendChild(actions);

      grid.appendChild(card);
    });
  }

  function escapeHtml(str){
    if(!str) return '';
    return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // modal
  function openModal(v){
    mdTitle.innerText = v.name;
    mdDesc.innerText = v.description || 'No description provided.';
    mdMan.innerText = v.manufacturer || 'N/A';
    mdAge.innerText = (v.required_age || 'Any');
    mdPrice.innerText = (v.price ? ('₹' + Number(v.price).toFixed(2)) : 'Free');
    mdDoses.innerText = v.doses_required || '1';
    mdQty.innerText = 'Qty: ' + (v.available_qty || 0);
    mdSide.innerText = v.side_effects || 'No side-effects listed.';
    const avail = availabilityColor(v.available_qty || 0);
    mdAvailNote.innerText = avail.text;
    mdAvailNote.style.color = avail.color;

    // book button preselect vaccine in booking page
    mdBook.onclick = ()=> location.href = 'patient-appointment-book.html?vaccine_id=' + v.id;

    mdMore.href = '#';
    modalBk.style.display = 'flex';
  }

  mdClose.onclick = ()=> modalBk.style.display = 'none';
  modalBk.onclick = (e)=> { if(e.target === modalBk) modalBk.style.display='none'; };

  // Filters + search events
  qEl.addEventListener('input', render);
  doseFilter.addEventListener('change', render);
  minAge.addEventListener('input', render);
  btnRefresh.addEventListener('click', loadAll);

  // logout
  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    localStorage.clear(); location.href='login.html';
  });

  // initial load
  await loadAll();

})();
</script>

</body>
</html>
