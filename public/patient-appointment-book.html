<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Book Appointment — Patient</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
:root{
  --accent:#0b5cff;
  --accent2:#06b6d4;
  --bg:#f4f8ff;
  --card:#ffffff;
  --muted:#6b7280;
  --danger:#ef4444;
  --ok:#10b981;
  --radius:14px;
  font-family:Inter,system-ui,Arial;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#fbfdff,var(--bg));color:#0f172a}
header{
  background:white;padding:12px 18px;border-bottom:1px solid #e6eef8;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;
}
.logo{font-weight:800;color:var(--accent)}
nav a{margin-left:10px;text-decoration:none;color:var(--muted);padding:8px 12px;border-radius:10px;font-weight:600}
nav a:hover{background:#eef4ff;color:var(--accent)}
nav a.active{background:#eef4ff;color:var(--accent);font-weight:700}
.wrap{max-width:980px;margin:20px auto;padding:14px}
h1{margin:0;font-size:24px;font-weight:800}
.muted{color:var(--muted);margin-top:6px}
.card{background:var(--card);padding:18px;border-radius:var(--radius);box-shadow:0 12px 28px rgba(10,30,80,0.06);margin-top:14px}
.form-grid{display:grid;grid-template-columns:1fr 320px;gap:18px}
@media(max-width:900px){ .form-grid{grid-template-columns:1fr} }

label{display:block;font-weight:700;margin-top:12px}
select,input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6eef8;margin-top:8px;font-size:14px}
.small{font-size:13px;color:var(--muted)}
.btn{background:var(--accent);color:white;padding:10px 14px;border-radius:10px;border:none;font-weight:800;cursor:pointer}
.btn.ghost{background:#f8fafc;border:1px solid #e6eef8;color:#0b2455}
.slot-grid{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.slot{padding:8px 12px;border-radius:10px;border:1px solid #e6eef8;cursor:pointer}
.slot.selected{background:var(--accent);color:white;border-color:var(--accent)}
.note{margin-top:8px;color:var(--muted);font-size:13px}
.alert{margin-top:8px;padding:10px;border-radius:8px;color:white}
.alert.warn{background:var(--danger)}
.alert.ok{background:var(--ok)}
.inline{display:inline-block}
.disabled{opacity:0.6;pointer-events:none}
.footer-note{font-size:13px;color:var(--muted);margin-top:12px}
</style>
</head>
<body>

<header>
  <div class="logo">Vaccination Portal</div>
  <nav>
    <a href="dashboard-patient.html">Dashboard</a>
    <a href="patient-vaccines.html">Vaccines</a>
    <a href="patient-appointment-book.html" class="active">Book Appointment</a>
    <a href="patient-appointments.html">My Appointments</a>
    <a href="patient-profile.html">Profile</a>
    <a id="logoutBtn" style="background:#ef4444;color:white;padding:8px 10px;border-radius:10px;text-decoration:none">Logout</a>
  </nav>
</header>

<div class="wrap">
  <h1>Book Vaccination Slot</h1>
  <div class="muted">Choose vaccine, center, date & time. We will check live stock before booking.</div>

  <div class="card">
    <div class="form-grid">

      <!-- LEFT: form -->
      <div>
        <label>Patient</label>
        <input id="patientName" readonly>

        <label>Vaccine</label>
        <select id="vaccineSel"><option>Loading...</option></select>

        <label>Detected Dose</label>
        <input id="doseSuggest" readonly>

        <label>Center</label>
        <select id="centerSel"><option>Loading...</option></select>

        <label>Appointment Date</label>
        <input id="apptDate" type="date" min="">

        <label>Time Slot</label>
        <div id="slots" class="slot-grid"></div>
        <div class="note">Choose a date to see available slots (server will validate slot availability).</div>

        <label>Notes (optional)</label>
        <textarea id="note" rows="3" placeholder="Any notes for staff"></textarea>

        <div id="stockMsg" class="note"></div>

        <button class="btn" id="btnBook">Book Appointment</button>
        <div id="result" class="note"></div>
      </div>

      <!-- RIGHT: summary & availability -->
      <aside>
        <div style="font-weight:800">Summary</div>
        <div class="card" style="margin-top:10px">
          <div class="small">Selected Vaccine</div>
          <div id="sumVaccine" style="font-weight:800;margin-top:6px">—</div>

          <div class="small" style="margin-top:10px">Required Age</div>
          <div id="sumAge" class="small">—</div>

          <div class="small" style="margin-top:10px">Available Quantity</div>
          <div id="sumQty" style="font-weight:800">—</div>

          <div class="small" style="margin-top:10px">Selected Center</div>
          <div id="sumCenter" class="small">—</div>

          <div class="small" style="margin-top:10px">Selected Slot</div>
          <div id="sumSlot" class="small">—</div>

          <div style="margin-top:12px">
            <button class="btn ghost" id="checkStockBtn">Check Live Stock</button>
            <div id="stockAlert" style="margin-top:8px"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:800">Dose Info</div>
          <div id="doseInfo" class="note" style="margin-top:8px">Loading...</div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:800">Quick Tips</div>
          <ul class="small" style="margin-top:8px;line-height:1.6">
            <li>Choose a date at least 1 day ahead.</li>
            <li>If stock is low, booking might not succeed — staff will confirm.</li>
            <li>You can cancel up to 12 hours before the slot (server rule).</li>
          </ul>
        </div>
      </aside>

    </div>
  </div>

  <div class="footer-note">If something fails, check browser console (F12 → Console) and server logs (PowerShell where node server.js is running).</div>
</div>

<script>
(async function(){
  // quick helpers
  const $ = id => document.getElementById(id);
  const token = localStorage.getItem('authToken');
  const user = JSON.parse(localStorage.getItem('user') || '{}');

  if(!token){
    alert('Please login first');
    location.href='login.html';
    return;
  }
  if(user.role !== 'patient'){
    alert('Only patients can book from this page');
    location.href='dashboard-admin.html';
    return;
  }

  // elements
  const patientName = $('patientName');
  const vaccineSel = $('vaccineSel');
  const centerSel = $('centerSel');
  const apptDate = $('apptDate');
  const slots = $('slots');
  const btnBook = $('btnBook');
  const result = $('result');
  const sumVaccine = $('sumVaccine');
  const sumAge = $('sumAge');
  const sumQty = $('sumQty');
  const sumCenter = $('sumCenter');
  const sumSlot = $('sumSlot');
  const doseSuggest = $('doseSuggest');
  const doseInfo = $('doseInfo');
  const noteEl = $('note');
  const stockMsg = $('stockMsg');
  const checkStockBtn = $('checkStockBtn');
  const stockAlert = $('stockAlert');

  let vaccines = [], centers = [], inventory = [];
  let patientRecord = null;
  let selectedSlot = null;
  let selectedVaccine = null;

  // min date = tomorrow
  const today = new Date();
  today.setDate(today.getDate() + 1);
  apptDate.min = today.toISOString().slice(0,10);

  // load patient
  async function loadPatient(){
    try{
      const res = await fetch('/api/patient/profile', { headers: { 'Authorization': 'Bearer ' + token }});
      if(!res.ok) throw new Error('Profile fetch failed');
      const data = await res.json();
      patientRecord = data || {};
      patientName.value = data.name || user.name || '';
    }catch(e){
      console.error('patient load error', e);
    }
  }

  // load vaccines/centers/inventory + my vaccinations
  async function loadData(){
    try{
      vaccineSel.innerHTML = '<option>Loading...</option>';
      centerSel.innerHTML = '<option>Loading...</option>';

      const [vRes, cRes, iRes, myVacRes] = await Promise.all([
        fetch('/api/vaccines', { headers: { 'Authorization': 'Bearer ' + token }}),
        fetch('/api/centers', { headers: { 'Authorization': 'Bearer ' + token }}),
        fetch('/api/inventory', { headers: { 'Authorization': 'Bearer ' + token }}),
        fetch('/api/my/vaccinations', { headers: { 'Authorization': 'Bearer ' + token }})
      ]);

      if(!vRes.ok || !cRes.ok || !iRes.ok) {
        throw new Error('One or more data endpoints failed');
      }

      vaccines = await vRes.json();
      centers = await cRes.json();
      inventory = await iRes.json();
      const myVacs = await myVacRes.json();

      populateVaccineSelect();
      populateCenters();
      determineDoseFromHistory(myVacs);

      // if ?vaccine_id= present, preselect
      const urlParams = new URLSearchParams(location.search);
      const vid = urlParams.get('vaccine_id');
      if(vid){
        vaccineSel.value = vid;
        onVaccineChange();
      }
    }catch(e){
      console.error('loadData err', e);
      vaccineSel.innerHTML = '<option value="">Error loading vaccines</option>';
      centerSel.innerHTML = '<option value="">Error loading centers</option>';
      alert('Error loading data. Check server logs or console.');
    }
  }

  function populateVaccineSelect(){
    vaccineSel.innerHTML = '<option value="">-- Select vaccine --</option>';
    (vaccines || []).forEach(v=>{
      const o = document.createElement('option');
      o.value = v.id;
      const doseType = v.dose_type || 'General';
      o.innerText = `${v.name} — ${doseType} — Age ${v.required_age||0}+`;
      vaccineSel.appendChild(o);
    });
  }

  function populateCenters(){
    centerSel.innerHTML = '<option value="">-- Select center --</option>';
    (centers || []).forEach(c=>{
      const o = document.createElement('option');
      o.value = c.id;
      o.innerText = `${c.name} — ${c.address || ''}`;
      centerSel.appendChild(o);
    });
  }

  function qtyForVaccine(vaccine_id){
    const nowDate = new Date().toISOString().slice(0,10);
    let sum = 0;
    (inventory || []).forEach(it=>{
      if(Number(it.vaccine_id) === Number(vaccine_id)){
        if(it.expiry_date && it.expiry_date < nowDate) return;
        sum += (parseInt(it.quantity) || 0);
      }
    });
    return sum;
  }

  function determineDoseFromHistory(myVacs){
    if(!Array.isArray(myVacs) || myVacs.length === 0){
      doseSuggest.value = '1 (first dose)';
      doseInfo.innerText = 'No vaccination history found — first dose recommended.';
      return;
    }
    myVacs.sort((a,b)=> new Date(a.given_on) - new Date(b.given_on));
    const last = myVacs[myVacs.length - 1];
    const next = (last.dose_no || 1) + 1;
    doseSuggest.value = `${next} (next dose)`;
    if(next === 2){
      const d = new Date(last.given_on); d.setDate(d.getDate() + 28);
      doseInfo.innerText = `Your last dose was on ${new Date(last.given_on).toLocaleDateString()}. Suggested next dose date: ${d.toLocaleDateString()}`;
    } else {
      doseInfo.innerText = `Last dose number ${last.dose_no} recorded on ${new Date(last.given_on).toLocaleDateString()}`;
    }
  }

  // when vaccine changes
  async function onVaccineChange(){
    const vid = vaccineSel.value;
    selectedVaccine = (vaccines || []).find(v => String(v.id) === String(vid)) || null;
    sumVaccine.innerText = selectedVaccine ? `${selectedVaccine.name} — ${selectedVaccine.dose_type || 'N/A'}` : '—';
    sumAge.innerText = selectedVaccine ? (selectedVaccine.required_age || 'Any') : '—';
    sumQty.innerText = selectedVaccine ? qtyForVaccine(selectedVaccine.id) : '—';
    if(selectedVaccine && qtyForVaccine(selectedVaccine.id) <= 0){
      stockMsg.innerText = 'Selected vaccine currently out of stock. Please choose another or try later.';
      stockMsg.style.color = 'var(--danger)';
    } else {
      stockMsg.innerText = '';
    }
  }

  vaccineSel.addEventListener('change', onVaccineChange);

  centerSel.addEventListener('change', ()=> {
    const c = (centers || []).find(cc => String(cc.id) === String(centerSel.value));
    sumCenter.innerText = c ? c.name : '—';
  });

  // generate timeslots for chosen date
  function generateSlots(dateStr){
    slots.innerHTML = '';
    selectedSlot = null;
    sumSlot.innerText = '—';

    if(!dateStr) return;

    const slotsArr = [];
    const start = 9, end = 17;
    for(let h=start; h<end; h++){
      slotsArr.push(`${String(h).padStart(2,'0')}:00`);
      slotsArr.push(`${String(h).padStart(2,'0')}:30`);
    }

    slotsArr.forEach(s=>{
      const el = document.createElement('div');
      el.className = 'slot';
      el.innerText = s;
      el.onclick = ()=> {
        document.querySelectorAll('.slot').forEach(x=>x.classList.remove('selected'));
        el.classList.add('selected');
        selectedSlot = s;
        sumSlot.innerText = `${dateStr} ${s}`;
      };
      slots.appendChild(el);
    });
  }

  apptDate.addEventListener('change', ()=> generateSlots(apptDate.value));

  // check live stock
  checkStockBtn.addEventListener('click', async ()=>{
    if(!selectedVaccine){ alert('Select vaccine first'); return; }
    checkStockBtn.disabled = true; checkStockBtn.innerText = 'Checking...';
    try{
      const res = await fetch('/api/inventory', { headers: { 'Authorization': 'Bearer ' + token }});
      const inv = await res.json();
      const qty = (inv || []).filter(i => Number(i.vaccine_id) === Number(selectedVaccine.id))
                      .reduce((s,it)=> s + (parseInt(it.quantity)||0), 0);
      stockAlert.innerText = `Live quantity: ${qty}`;
      stockAlert.className = qty > 0 ? 'alert ok' : 'alert warn';
    }catch(e){
      stockAlert.innerText = 'Error checking stock';
      stockAlert.className = 'alert warn';
    }finally{
      checkStockBtn.disabled = false; checkStockBtn.innerText = 'Check Live Stock';
    }
  });

  // booking
 btnBook.addEventListener('click', async () => {

    // CREATE FINAL APPOINTMENT DATE + TIME
    const apptDateTime = new Date(apptDate.value + 'T' + selectedSlot + ':00');

    result.innerText = '';

    if (!patientRecord || !patientRecord.id) {
      alert('Patient record not found. Please complete your profile.');
      return;
    }

    if (!vaccineSel.value) {
      alert('Select a vaccine');
      return;
    }

    if (!centerSel.value) {
      alert('Select a center');
      return;
    }

    if (!apptDate.value) {
      alert('Select appointment date');
      return;
    }

    if (!selectedSlot) {
      alert('Select a time slot');
      return;
    }

    const qty = qtyForVaccine(vaccineSel.value);
    if (qty <= 0) {
      alert('Selected vaccine has no stock. Choose another vaccine or try later.');
      return;
    }

    btnBook.disabled = true;
    btnBook.innerText = 'Booking...';

    try {
      const payload = {
        patient_id: patientRecord.id,
        vaccine_id: vaccineSel.value,
        appointment_date: apptDateTime.toISOString().slice(0, 19).replace('T', ' '),
        center_id: centerSel.value,
        dose_no: (doseSuggest.value && parseInt(doseSuggest.value)) || 1,
        note: noteEl.value
      };

      const res = await fetch('/api/appointments', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(payload)
      });

      const out = await res.json();
      if (out.success) {
        result.style.color = 'green';
        result.innerText = 'Appointment booked successfully!';
        setTimeout(() => location.href = 'patient-appointments.html', 800);
      } else {
        result.style.color = 'red';
        result.innerText = out.msg || 'Booking failed';
      }

    } catch (e) {
      console.error('Booking error:', e);
      result.style.color = 'red';
      result.innerText = 'Network error';
    } finally {
      btnBook.disabled = false;
      btnBook.innerText = 'Book Appointment';
    }
});



  // initial load
  await loadPatient();
  await loadData();

  // logout
  $('logoutBtn').addEventListener('click', ()=> { localStorage.clear(); location.href='login.html'; });

})();
</script>

</body>
</html>
